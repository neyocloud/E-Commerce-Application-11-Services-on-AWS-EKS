pipeline {
  agent any

  options {
    timestamps()
    timeout(time: 30, unit: 'MINUTES')   // prevent endless hangs
  }

  parameters {
    choice(
      name: 'ACTION',
      choices: ['apply', 'destroy'],
      description: 'Select the Terraform action to perform'
    )
  }

  environment {
    AWS_REGION          = 'us-east-1'     // change if needed
    TF_PLUGIN_CACHE_DIR = '/var/lib/jenkins/.terraform.d/plugin-cache'
  }

  stages {

    stage('Checkout from Git') {
      steps {
        // Pipeline-from-SCM usually checks out automatically, but this is safe/explicit
        checkout scm
        echo 'Git repository checked out.'
      }
    }

    stage('Terraform version') {
      steps {
        sh 'terraform --version'
      }
    }

    stage('Terraform init') {
      steps {
        withCredentials([
          usernamePassword(
            credentialsId: 'aws-access-key',
            usernameVariable: 'AWS_ACCESS_KEY_ID',
            passwordVariable: 'AWS_SECRET_ACCESS_KEY'
          )
        ]) {
          dir('eks-terraform') {
            sh '''
              set -euxo pipefail
              mkdir -p "${TF_PLUGIN_CACHE_DIR}"
              terraform init -input=false --reconfigure
            '''
          }
        }
      }
    }

    stage('Terraform validate') {
      steps {
        dir('eks-terraform') {
          sh 'terraform validate'
        }
      }
    }

    stage('Terraform plan') {
      steps {
        withCredentials([
          usernamePassword(
            credentialsId: 'aws-access-key',
            usernameVariable: 'AWS_ACCESS_KEY_ID',
            passwordVariable: 'AWS_SECRET_ACCESS_KEY'
          )
        ]) {
          dir('eks-terraform') {
            sh '''
              set -euxo pipefail
              terraform plan -input=false -no-color -out=tfplan
            '''
            // keep the plan for troubleshooting if needed
            sh 'terraform show -no-color tfplan > tfplan.txt || true'
            archiveArtifacts artifacts: 'eks-terraform/tfplan.txt', onlyIfSuccessful: false, allowEmptyArchive: true
          }
        }
      }
    }

    stage('Terraform apply') {
      when { expression { params.ACTION == 'apply' } }
      steps {
        withCredentials([
          usernamePassword(
            credentialsId: 'aws-access-key',
            usernameVariable: 'AWS_ACCESS_KEY_ID',
            passwordVariable: 'AWS_SECRET_ACCESS_KEY'
          )
        ]) {
          dir('eks-terraform') {
            sh 'terraform apply -input=false -auto-approve'
          }
        }
      }
    }

    stage('Terraform destroy') {
      when { expression { params.ACTION == 'destroy' } }
      steps {
        withCredentials([
          usernamePassword(
            credentialsId: 'aws-access-key',
            usernameVariable: 'AWS_ACCESS_KEY_ID',
            passwordVariable: 'AWS_SECRET_ACCESS_KEY'
          )
        ]) {
          dir('eks-terraform') {
            sh 'terraform destroy -input=false -auto-approve'
          }
        }
      }
    }
  }

  post {
    always {
      echo "Build finished at $(date)"
      cleanWs(deleteDirs: true)
    }
  }
}
