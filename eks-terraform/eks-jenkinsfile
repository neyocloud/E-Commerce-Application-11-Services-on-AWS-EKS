pipeline {
  agent any

  options {
    durabilityHint('MAX_SURVIVABILITY')
    timestamps()
    timeout(time: 60, unit: 'MINUTES')
    buildDiscarder(logRotator(daysToKeepStr: '7', numToKeepStr: '10')) // keep 10 builds / 7 days
  }

  environment {
    TF_IN_AUTOMATION     = '1'
    TF_INPUT             = '0'
    TF_PLUGIN_CACHE_DIR  = '/var/lib/jenkins/.terraform.d/plugin-cache'
    TF_LOG               = 'INFO'
    TF_LOG_PATH          = "${WORKSPACE}/terraform.init.log"
    AWS_DEFAULT_REGION   = 'us-east-1'
    // HTTPS_PROXY = 'http://proxy.internal:3128'
    // HTTP_PROXY  = 'http://proxy.internal:3128'
    // NO_PROXY    = '169.254.169.254,localhost,127.0.0.1,.amazonaws.com'
  }

  stages {
    stage('Checkout from Git') {
      steps {
        checkout([$class: 'GitSCM',
          branches: [[name: '*/main']],
          userRemoteConfigs: [[url: 'https://github.com/neyocloud/E-Commerce-Application-11-Services-on-AWS-EKS']]
        ])
      }
    }

    stage('Preflight: network') {
      options { timeout(time: 2, unit: 'MINUTES') }
      steps {
        sh '''
          set -euxo pipefail
          mkdir -p /var/lib/jenkins/.terraform.d/plugin-cache || true

          echo "=== Network snapshot ==="
          uname -a || true
          date
          ip route || true
          cat /etc/resolv.conf || true
          getent hosts registry.terraform.io || true
          getent hosts releases.hashicorp.com || true
          getent hosts objects.githubusercontent.com || true

          echo "=== Testing endpoints (DNS+TLS) ==="
          for url in \
            https://registry.terraform.io \
            https://releases.hashicorp.com \
            https://objects.githubusercontent.com
          do
            echo "--- $url ---"
            curl -sS -v --connect-timeout 3 --max-time 8 -I "$url" >/dev/null || echo "FAIL: $url"
          done

          echo "=== AWS identity (non-fatal) ==="
          aws sts get-caller-identity || true
        '''
      }
    }

    stage('Terraform version') {
      steps { sh 'terraform --version' }
    }

    stage('Terraform init') {
      steps {
        dir('eks-terraform') {
          retry(2) {
            timeout(time: 20, unit: 'MINUTES') {
              // Stable: no -upgrade unless you intend to upgrade providers
              sh 'terraform init -input=false -no-color --reconfigure'
            }
          }
        }
      }
    }

    stage('Terraform validate') {
      options { timeout(time: 3, unit: 'MINUTES') }
      steps {
        dir('eks-terraform') {
          sh '''
            set -euxo pipefail
            pwd; ls -la
            time terraform validate -no-color -json | tee ../tf-validate.json
          '''
        }
      }
    }

    stage('Terraform plan') {
      steps {
        withCredentials([
          string(credentialsId: 'aws-access-key',  variable: 'AWS_ACCESS_KEY_ID'),
          string(credentialsId: 'aws-secret-key',  variable: 'AWS_SECRET_ACCESS_KEY')
          // If you use temporary creds, UNCOMMENT the next line:
          // , string(credentialsId: 'aws-session-token', variable: 'AWS_SESSION_TOKEN')
        ]) {
          dir('eks-terraform') {
            sh '''
              echo "Region: $AWS_DEFAULT_REGION"
              aws sts get-caller-identity || true
              TF_LOG=INFO terraform plan -no-color -out=tfplan 2> plan.debug.log
            '''
          }
        }
      }
    }

    stage('Terraform apply') {
      when { expression { return params.APPLY == true } }
      steps {
        withCredentials([
          string(credentialsId: 'aws-access-key',  variable: 'AWS_ACCESS_KEY_ID'),
          string(credentialsId: 'aws-secret-key',  variable: 'AWS_SECRET_ACCESS_KEY')
          // If using temporary creds, uncomment:
          // , string(credentialsId: 'aws-session-token', variable: 'AWS_SESSION_TOKEN')
        ]) {
          dir('eks-terraform') {
            sh 'terraform apply -no-color -auto-approve tfplan'
          }
        }
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'terraform.init.log, tf-validate.json, eks-terraform/plan.debug.log', allowEmptyArchive: true
      cleanWs(deleteDirs: true)
    }
  }
}
